# Export4C
Export4C is a kit work as a build step calculates and exports actual address and size of each function in C source, and can be referenced by other sources in the project.

Export4C is used by [KNSoft.org](https://knsoft.org) internally, so there is no further compatibility and testing for IDE, compiler, SDK other than latest Visual Studio yet, and supports simple C source only. Now Export4C is open-source, may be more powerful features will be implemented in the future.

## Why
Actual address in memory and size of function entities may required in some cases, e.g. code injection, SMC (Self-Modifying Code), etc. But it's hard to calculate them in C source, see "`ExampleProc`" function in the example below:
```C
int ExampleProc() {
    return 0;
}

void ExampleProcEnd() {}
```
Unfortunately, "`ExampleProc`" and "`(SIZE_T)ExampleProcEnd - (SIZE_T)ExampleProc`" are not identical to actual address and size of "`ExampleProc`" function entity in most cases. In fact, it depends on compiler:  
1. In MSVC complier, function name may be equals to the pointer to JMP stub (generated by "Incremental Link Table", or declared external function without "__declspec(dllimport)" decorator) rather than the actual address.
2. "`sizeof`" operator not works for a function, and the difference between actual memory address of functions may unpredictable because of optimizations (e.g. COMDAT, inline expansion, function alignment, etc.) and order in memory.

So now, Export4C offering an easy and reliable way to get them, and moreover, compiler and linker can keep the way to work as it should be.

## How to use
The following two steps reference the actual address and size of "`ExampleProc`" function which defined in "ExampleProc.c" by using Export4C:
```C
// ExampleProc.c
int __stdcall ExampleProc(int a, int b) {
    return a + b;
}
```
1. Turn on ASM listing file output, that's Export4C needs. In C/C++ project properties page, turn to **\[C\/C++\]** - **\[Output Files\]**, set **"Assembler Output"** to **"Assembly Only" (/FA)** or **"Assembly With Source Code" (/FAs)**. And turn to **\[Advanced\]**, **TURN OFF** **"Whole Program Optimization"**, which effects ASM output.
2. Add Export4C as a build step before linking. In C/C++ project properties page, turn to **\[Build Events\]** - **\[Pre-Link Event\]**, add command line like following: "`PowerShell -ExecutionPolicy RemoteSigned -File Export4C.ps1 -Source ExampleProc.c -IntDir $(IntDir)`". "Source" parameter specified path of C source, which contains the definition of the target function. "IntDir" parameter specified the directory which contains ASM listing file and object file output, namely "`$(IntDir)`" environment variable by default. For more information about parameters, use "`Get-Help`" cmdlet in PowerShell.

Now, you can add extern symbol definitions in C source other than "ExampleProc.c" in the same project, where to reference them:

```C
typedef int (__stdcall *PEXAMPLEPROC)(int a, int b);
extern PEXAMPLEPROC E4C_Addr_ExampleProc;
extern size_t E4C_Size_ExampleProc;
```
External symbol "`E4C_Addr_`" + "`[Function Name]`" exported by Export4C, defined as the same proto, corresponding to the actual address. And symbol "`E4C_Size_`" + "`[Function Name]`" defined as "`size_t`", corresponding to the size in bytes.

Caution:
1. The pre-link command line calls PowerShell, make sure the "ExecutionPolicy" and "File" parameters are right to run Export4C
2. The target C source ("ExampleProc.c") should be **as simple as possible**.
3. **Call external procedure in injected code may run into unexpected area** and leads to access violation or unpredictable code execution, because external procedure may not exists or cannot be addressing correctly. **Disable features like JMC (Just My Code) , Security Cookie, SDL and RTC to prevent external procedure calls generated.**
4. Export4C doesn't support reference the additional symbols in the target C source itself ("ExampleProc.c") yet, it will encountered symbol redefinition errors.

The project in this repository is also the example to use Export4C:
+ Example1: Reference the actual address and size of specified function
+ Example2: Print the result of comparison between with and without Export4C
+ Example3: Inject and execute code in remote process.

## How it works
It hard to calculate actual address and size of a function in C, on the contrary, it's very easy in assembly language by using labels outside the procedure, like MASM:
```ASM
ExampleProc_Start:
ExampleProc PROC a, b
    MOV     EAX, a
    ADD     EAX, b
    RET
ExampleProc ENDP
ExampleProc_End:
```
In the example above, "`offset ExampleProc_Start`" equals to the actual address of procedure "`ExampleProc`" entity, and "`offset ExampleProc_End - offset ExampleProc_Start`" equals to the size in bytes.

MSVC compiler can generate ASM output, Export4C will do the following steps:
1.  Analyze and rewrite the ASM output, add public symbol exports of actual address and size for each procedure.
2.  Call MASM to assemble the new ASM source, and replace the original object file.

Caution, ASM listing file outputted by MSVC compiler is not identical to the ASM source, it's necessary to fix lots of syntax errors and symbol conflicts before call the MASM. So we shoud keep the C source as simple as possible, although Export4C did some.

## What will be
1. Improve compatibility for different C/C++ sources
2. Add more features, and export more useful symbols
3. Improve integration for Visual Studio
4. Improve speed, avoid unnecessary operations for latest build
5. Complete script abilities, like verbose output on PowerShell, errors or information output on Visual Studio